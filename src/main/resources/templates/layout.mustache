<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fonckys Collectibles - Tienda de Coleccionables</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="stars"></div>
<div class="container">
    <header class="header">
        <div class="logo-section">
            <div class="logo-icon">üéÆ</div>
            <h1 class="site-title">Fonckys <span class="highlight">Collectibles</span></h1>
        </div>
        <nav class="nav">
            <a href="/items" class="nav-link">üè† Inicio</a>
            <a href="/items/new" class="nav-link cta">‚ú® Nuevo Item</a>
        </nav>
    </header>

    <main class="main-content">
        {{{content}}}
    </main>

    <footer class="footer">
        <p>¬© 2025 Fonckys Collectibles | Todos los derechos reservados</p>
    </footer>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Definimos la URL del WebSocket.
        // Usamos 'ws://' (WebSocket) en lugar de 'http://'
        // La ruta debe ser la misma que definimos en App.java: "/price-updates"
        const wsUrl = `ws://${window.location.host}/price-updates`;

        let ws; // Variable para guardar la conexi√≥n

        function connect() {
            ws = new WebSocket(wsUrl);

            // 2. ¬øQu√© hacer cuando el navegador se conecta?
            ws.onopen = () => {
                console.log('WebSocket conectado al servidor de precios.');
            };

            // 3. ¬°LO M√ÅS IMPORTANTE! ¬øQu√© hacer cuando llega un mensaje?
            ws.onmessage = (event) => {
                console.log('Mensaje recibido:', event.data);

                try {
                    // 4. Convertimos el mensaje JSON (texto) a un objeto JavaScript
                    const message = JSON.parse(event.data);

                    // 5. Verificamos si es un mensaje de actualizaci√≥n de precio
                    if (message.type === 'PRICE_UPDATE') {
                        updatePriceOnPage(message.itemId, message.newPrice);
                    }
                } catch (e) {
                    console.error('Error al parsear mensaje de WebSocket:', e);
                }
            };

            // 6. ¬øQu√© hacer si la conexi√≥n se cierra? (Intenta reconectar)
            ws.onclose = () => {
                console.log('WebSocket desconectado. Intentando reconectar en 3 seg...');
                // Intenta reconectar despu√©s de 3 segundos
                setTimeout(connect, 3000);
            };

            // 7. ¬øQu√© hacer si hay un error?
            ws.onerror = (error) => {
                console.error('Error en WebSocket:', error);
                ws.close(); // Cierra la conexi√≥n para forzar la reconexi√≥n
            };
        }

        // 8. Funci√≥n que actualiza el HTML
        function updatePriceOnPage(itemId, newPrice) {
            // Buscamos la tarjeta del item en la p√°gina de /items
            // (Usamos un selector de atributo que busca el data-id)
            const itemCard = document.querySelector(`.item-card[data-id="${itemId}"]`);

            if (itemCard) {
                // Si encontramos la tarjeta, buscamos el elemento del precio
                const priceElement = itemCard.querySelector('.price-value');
                if (priceElement) {
                    console.log(`Actualizando precio para ${itemId}: $${newPrice}`);
                    // Usamos toFixed(2) para asegurar 2 decimales, ej: $683.47
                    priceElement.textContent = `$${newPrice.toFixed(2)}`;

                    // (Opcional) Agregamos un efecto visual para que "brille"
                    priceElement.style.transition = 'none';
                    priceElement.style.color = '#4CAF50'; // Verde
                    priceElement.style.transform = 'scale(1.1)';

                    setTimeout(() => {
                        priceElement.style.transition = 'all 0.3s ease';
                        priceElement.style.color = ''; // Vuelve al color original
                        priceElement.style.transform = 'scale(1)';
                    }, 100); // El parpadeo dura 100ms
                }
            }
        }

        // 9. Iniciar la conexi√≥n cuando la p√°gina cargue
        connect();
    });
</script>
</body>
</html>